# =============================================================
# Homelab Automation — Environment Configuration
# =============================================================
# Copy this file to .env and fill in your values:
#   cp .env.example .env
#
# NEVER commit the plain .env file to git!
# Use ./scripts/secrets-encrypt.sh to encrypt → .env.enc (safe to commit)
# =============================================================

# --- Home Assistant ---
HA_URL=http://homeassistant.local:8123
HA_TOKEN=your_long_lived_access_token_here

# --- InfluxDB v2 ---
INFLUXDB_URL=http://your-influxdb-host:8086
INFLUXDB_TOKEN=your_influxdb_token_here
INFLUXDB_ORG=your_org_id_here
INFLUXDB_BUCKET=hass

# --- MQTT ---
# Must be the SAME broker HA uses (for MQTT auto-discovery to work).
# Use your external broker IP, NOT "mqtt" (the Docker container).
MQTT_HOST=mqtt
MQTT_PORT=1883
MQTT_USERNAME=
MQTT_PASSWORD=

# --- AI / LLM ---
OLLAMA_URL=http://ollama:11434
OPENAI_API_KEY=
ANTHROPIC_API_KEY=
GEMINI_API_KEY=

# --- PV Forecast Service ---
# Entity IDs for your PV arrays — must be total_increasing cumulative kWh sensors
# (e.g. Riemann sum integration of the array power sensor)
PV_EAST_ENERGY_ENTITY_ID=sensor.inverter_pv_east_energy
PV_EAST_CAPACITY_KWP=5.0
PV_EAST_AZIMUTH=90
PV_EAST_TILT=30

PV_WEST_ENERGY_ENTITY_ID=sensor.inverter_pv_west_energy
PV_WEST_CAPACITY_KWP=5.0
PV_WEST_AZIMUTH=-90
PV_WEST_TILT=30

# Forecast.Solar "today" entities (optional — used as extra model feature)
# The code auto-discovers the matching "tomorrow" entity by replacing _today with _tomorrow.
FORECAST_SOLAR_EAST_ENTITY_ID=sensor.energy_production_today_east
FORECAST_SOLAR_WEST_ENTITY_ID=sensor.energy_production_today_west

# Location (leave at 0 to auto-detect from Home Assistant)
PV_LATITUDE=0
PV_LONGITUDE=0

# ML model hyperparameters (Gradient Boosting)
# MODEL_N_ESTIMATORS=200
# MODEL_MAX_DEPTH=5
# MODEL_LEARNING_RATE=0.05
# MODEL_SUBSAMPLE=0.8
# MODEL_MIN_SAMPLES_LEAF=10
# MODEL_MIN_TRAINING_SAMPLES=50
# MODEL_CV_FOLDS=3

# Fallback estimate parameters (used when not enough data for ML)
# FALLBACK_SYSTEM_EFFICIENCY=0.78
# FALLBACK_PEAK_IRRADIANCE=1000.0

# DATA_HISTORY_DAYS=90

# --- Smart EV Charging Service ---
# Economics (ct/kWh) — fixed rates, no EPEX spot market
EV_GRID_PRICE_CT=25.0
EV_FEED_IN_TARIFF_CT=7.0
EV_REIMBURSEMENT_CT=25.0

# EV battery SoC (from car, e.g. Audi Connect) — leave empty to disable
# When set, the service computes energy needed from SoC + capacity automatically.
# Set this to your car's SoC entity, e.g.: sensor.audi_q4_e_tron_state_of_charge
EV_SOC_ENTITY=

# Sensor entities (defaults match typical Amtron + Sungrow + Shelly setup)
# Grid connection meter (positive = exporting, negative = importing)
# GRID_POWER_ENTITY=sensor.power_meter_active_power
# Household consumption (Shelly 3EM, always positive)
# HOUSE_POWER_ENTITY=sensor.shelly3em_main_channel_total_power
# PV DC input power
# PV_POWER_ENTITY=sensor.inverter_input_power

# Home battery (positive = charging, negative = discharging)
# BATTERY_POWER_ENTITY=sensor.batteries_charge_discharge_power
# BATTERY_SOC_ENTITY=sensor.batteries_state_of_capacity
# BATTERY_MIN_SOC_PCT=20.0
# BATTERY_EV_ASSIST_MAX_W=2000.0

# PV forecast (used for battery-aware decisions)
# PV_FORECAST_REMAINING_ENTITY=sensor.pv_ai_forecast_today_remaining_kwh
# PV_FORECAST_GOOD_KWH=15.0

# Wallbox power limits (W) — defaults match Amtron 3-phase
# WALLBOX_MAX_POWER_W=11000
# WALLBOX_MIN_POWER_W=4200
# ECO_CHARGE_POWER_W=5000

# PV surplus tuning
# GRID_RESERVE_W=200
# SURPLUS_START_HYSTERESIS_W=300
# RAMP_STEP_W=500

# Control loop interval (seconds)
# CONTROL_INTERVAL_SECONDS=30

# --- Orchestrator Service ---
# LLM provider: gemini (default), openai, anthropic, ollama
LLM_PROVIDER=gemini
# GEMINI_MODEL=gemini-2.0-flash
# OPENAI_MODEL=gpt-4o
# ANTHROPIC_MODEL=claude-sonnet-4-20250514
# OLLAMA_MODEL=llama3
# LLM_MAX_TOKENS=4096
# LLM_TEMPERATURE=0.7

# Embedding models (for semantic memory — one per provider)
# GEMINI_EMBEDDING_MODEL=gemini-embedding-001
# GEMINI_EMBEDDING_DIMS=768
# OPENAI_EMBEDDING_MODEL=text-embedding-3-small
# OLLAMA_EMBEDDING_MODEL=nomic-embed-text

# Telegram bot (create via @BotFather)
TELEGRAM_BOT_TOKEN=
# Comma-separated chat IDs allowed to interact (use /whoami to find yours)
TELEGRAM_ALLOWED_CHAT_IDS=

# Proactive features
# MORNING_BRIEFING_TIME=07:00
# EVENING_BRIEFING_TIME=21:00
# ENABLE_PROACTIVE_SUGGESTIONS=true
# ENABLE_MORNING_BRIEFING=true
# ENABLE_EVENING_BRIEFING=false
# ENABLE_SEMANTIC_MEMORY=true
# PROACTIVE_STARTUP_DELAY_SECONDS=120
# CONSOLIDATION_STARTUP_DELAY_SECONDS=300
# CONSOLIDATION_CHECK_INTERVAL_SECONDS=600

# Memory settings
# MAX_CONVERSATION_HISTORY=50
# MAX_DECISIONS=500

# Semantic memory tuning
# SEMANTIC_MEMORY_MAX_ENTRIES=5000
# SEMANTIC_MEMORY_TEXT_MAX_LEN=2000
# SEMANTIC_MEMORY_SEARCH_TOP_K=5
# SEMANTIC_MEMORY_RECENCY_WEIGHT=0.15
# SEMANTIC_MEMORY_RECENCY_HALF_LIFE_DAYS=30
# MEMORY_SIMILARITY_THRESHOLD=0.5
# MEMORY_CONTEXT_RESULTS=3

# Memory consolidation (nightly merge of old conversation memories)
# MEMORY_CONSOLIDATION_HOUR=3
# MEMORY_CONSOLIDATION_MIN_AGE_DAYS=1.0
# MEMORY_CONSOLIDATION_BATCH_LIMIT=50
# MEMORY_CONSOLIDATION_BATCH_SIZE=10
# MEMORY_CONSOLIDATION_MIN_BATCH_SIZE=5

# Google Calendar integration (optional — enables absence awareness & reminders)
# 1. Create a Service Account in Google Cloud Console (enable Calendar API)
# 2. Download the JSON key file
# 3. Share your family calendar with the service account email (Viewer)
# 4. Create an "Orchestrator" calendar and share with the service account (Editor)
GOOGLE_CALENDAR_CREDENTIALS_FILE=/app/data/google-credentials.json
# Or use base64-encoded JSON for Docker convenience:
# GOOGLE_CALENDAR_CREDENTIALS_JSON=
# Family calendar ID (read-only) — the email-like ID from Google Calendar settings
GOOGLE_CALENDAR_FAMILY_ID=
# Orchestrator calendar ID (read/write) — create a new calendar for the orchestrator
GOOGLE_CALENDAR_ORCHESTRATOR_ID=

# Energy prices (ct/kWh) — used by orchestrator for cost estimates
GRID_PRICE_CT=25.0
FEED_IN_TARIFF_CT=7.0
OIL_PRICE_PER_KWH_CT=10.0

# Household info
HOUSEHOLD_USERS=Hans,Nicole
# HOUSEHOLD_LANGUAGE=de

# --- EV Forecast Service ---
# EV battery specs (Audi A6 e-tron)
EV_BATTERY_CAPACITY_GROSS_KWH=83.0
EV_BATTERY_CAPACITY_NET_KWH=76.0
EV_CONSUMPTION_KWH_PER_100KM=22.0

# Audi Connect Account 1 (Hans) — entity IDs from the integration
AUDI_ACCOUNT1_NAME=Hans
AUDI_ACCOUNT1_SOC_ENTITY=sensor.audi_a6_e_tron_state_of_charge
AUDI_ACCOUNT1_RANGE_ENTITY=sensor.audi_a6_e_tron_range
AUDI_ACCOUNT1_CHARGING_ENTITY=sensor.audi_a6_e_tron_charging_state
AUDI_ACCOUNT1_PLUG_ENTITY=sensor.audi_a6_e_tron_plug_state
AUDI_ACCOUNT1_MILEAGE_ENTITY=sensor.audi_a6_e_tron_mileage
AUDI_ACCOUNT1_REMAINING_CHARGE_ENTITY=sensor.audi_a6_e_tron_remaining_charge_time
AUDI_ACCOUNT1_VIN=

# Audi Connect Account 2 (Nicole) — usually same entities with _2 suffix
AUDI_ACCOUNT2_NAME=Nicole
AUDI_ACCOUNT2_SOC_ENTITY=sensor.audi_a6_e_tron_state_of_charge_2
AUDI_ACCOUNT2_RANGE_ENTITY=sensor.audi_a6_e_tron_range_2
AUDI_ACCOUNT2_CHARGING_ENTITY=sensor.audi_a6_e_tron_charging_state_2
AUDI_ACCOUNT2_PLUG_ENTITY=sensor.audi_a6_e_tron_plug_state_2
AUDI_ACCOUNT2_MILEAGE_ENTITY=sensor.audi_a6_e_tron_mileage_2
AUDI_ACCOUNT2_REMAINING_CHARGE_ENTITY=sensor.audi_a6_e_tron_remaining_charge_time_2
AUDI_ACCOUNT2_VIN=

# Trip prediction — Nicole's default commute (Mon-Thu)
NICOLE_COMMUTE_KM=22.0
NICOLE_COMMUTE_DAYS=mon,tue,wed,thu
NICOLE_DEPARTURE_TIME=07:00
NICOLE_ARRIVAL_TIME=18:00

# Hans: trips over this distance → takes train (no EV impact)
HANS_TRAIN_THRESHOLD_KM=350.0

# Known destinations with one-way distances in km (JSON)
# KNOWN_DESTINATIONS={"Münster": 60, "Aachen": 80, "STR": 500, "Lengerich": 22}

# Geocoding for unknown destinations (auto-detects from HA if 0)
# HOME_LATITUDE=0
# HOME_LONGITUDE=0
# GEOCODING_ROAD_FACTOR=1.3

# Charging plan parameters
# MIN_SOC_PCT=20.0          # Never plan below this SoC
# BUFFER_SOC_PCT=10.0       # Extra buffer above minimum needed
# MIN_ARRIVAL_SOC_PCT=15.0  # Min SoC at destination
# DEFAULT_ASSUMED_SOC_PCT=50.0  # Assumed SoC when actual value is unknown

# Urgency thresholds
# CRITICAL_URGENCY_HOURS=2.0    # Departure within this → critical urgency
# HIGH_URGENCY_HOURS=6.0        # Departure within this → high urgency
# FAST_MODE_THRESHOLD_KWH=15.0  # Deficit above this → Fast instead of Eco
# EARLY_DEPARTURE_HOUR=10       # Tomorrow departure before this → charge overnight

# Scheduling intervals (minutes)
# PLAN_UPDATE_MINUTES=30
# VEHICLE_CHECK_MINUTES=15

# --- Health Monitor Service ---
# Telegram alerting (can reuse same bot as orchestrator)
# TELEGRAM_ALERT_CHAT_IDS=

# Services to monitor (comma-separated, must match MQTT heartbeat names)
# MONITORED_SERVICES=orchestrator,pv-forecast,smart-ev-charging,ev-forecast

# Monitoring intervals
# HEARTBEAT_TIMEOUT_SECONDS=300
# INFRASTRUCTURE_CHECK_MINUTES=5
# DIAGNOSTIC_RUN_MINUTES=30
# DOCKER_CHECK_MINUTES=2
# ALERT_COOLDOWN_MINUTES=30
# DAILY_SUMMARY_HOUR=8

# HTTP timeout for HA/InfluxDB health checks (seconds)
# HTTP_CHECK_TIMEOUT_SECONDS=10.0

# HA entities to watch for unavailable/unknown state (comma-separated)
# WATCHED_ENTITIES=sensor.inverter_input_power,sensor.power_meter_active_power,sensor.batteries_state_of_capacity

# --- General ---
LOG_LEVEL=INFO
TIMEZONE=Europe/Berlin

# =============================================================
# Homelab Automation — Environment Configuration
# =============================================================
# Copy this file to .env and fill in your values:
#   cp .env.example .env
#
# NEVER commit the plain .env file to git!
# Use ./scripts/secrets-encrypt.sh to encrypt → .env.enc (safe to commit)
# =============================================================


# ╔═══════════════════════════════════════════════════════════╗
# ║  1. CORE INFRASTRUCTURE                                  ║
# ╚═══════════════════════════════════════════════════════════╝

# --- Home Assistant ---
HA_URL=http://homeassistant.local:8123
HA_TOKEN=your_long_lived_access_token_here

# --- InfluxDB v2 ---
INFLUXDB_URL=http://your-influxdb-host:8086
INFLUXDB_TOKEN=your_influxdb_token_here
INFLUXDB_ORG=your_org_id_here
INFLUXDB_BUCKET=hass

# --- MQTT ---
# Must be the SAME broker HA uses (for MQTT auto-discovery to work).
# Use your external broker IP, NOT "mqtt" (the Docker container name).
MQTT_HOST=mqtt
MQTT_PORT=1883
MQTT_USERNAME=
MQTT_PASSWORD=


# ╔═══════════════════════════════════════════════════════════╗
# ║  2. AI / LLM PROVIDERS                                   ║
# ╚═══════════════════════════════════════════════════════════╝

# At least one provider key is required for the orchestrator.
GEMINI_API_KEY=
OPENAI_API_KEY=
ANTHROPIC_API_KEY=

# Local LLM via Ollama (optional)
OLLAMA_URL=http://ollama:11434

# Shared ChromaDB vector store (used by orchestrator semantic memory)
# Keep CHROMA_AUTH_TOKEN in Vaultwarden and inject into .env during deploy.
CHROMA_URL=http://192.168.0.50:8300
CHROMA_AUTH_TOKEN=


# ╔═══════════════════════════════════════════════════════════╗
# ║  3. ENERGY PRICES & ECONOMICS                            ║
# ╚═══════════════════════════════════════════════════════════╝
# Shared by orchestrator and smart-ev-charging.

# Fixed rates (ct/kWh) — no EPEX spot market
GRID_PRICE_CT=25.0
FEED_IN_TARIFF_CT=7.0
OIL_PRICE_PER_KWH_CT=10.0

# Employer EV charging reimbursement (smart-ev-charging only)
REIMBURSEMENT_CT=25.0


# ╔═══════════════════════════════════════════════════════════╗
# ║  4. SERVICE: ORCHESTRATOR                                 ║
# ╚═══════════════════════════════════════════════════════════╝

# -- LLM provider --
# Options: gemini (default), openai, anthropic, ollama
LLM_PROVIDER=gemini
# GEMINI_MODEL=gemini-2.0-flash
# OPENAI_MODEL=gpt-4o
# ANTHROPIC_MODEL=claude-sonnet-4-20250514
# OLLAMA_MODEL=llama3
# LLM_TEMPERATURE=0.7
# LLM_MAX_TOKENS=4096
# LLM_MAX_TOOL_ROUNDS=10

# -- Embedding models (for semantic memory) --
# GEMINI_EMBEDDING_MODEL=gemini-embedding-001
# GEMINI_EMBEDDING_DIMS=768
# OPENAI_EMBEDDING_MODEL=text-embedding-3-small
# OLLAMA_EMBEDDING_MODEL=nomic-embed-text

# -- Telegram bot --
# Create via @BotFather, use /whoami to find chat IDs
TELEGRAM_BOT_TOKEN=
TELEGRAM_ALLOWED_CHAT_IDS=

# -- Proactive features --
# MORNING_BRIEFING_TIME=07:00
# EVENING_BRIEFING_TIME=21:00
# ENABLE_PROACTIVE_SUGGESTIONS=true
# ENABLE_MORNING_BRIEFING=true
# ENABLE_EVENING_BRIEFING=false
# PROACTIVE_CHECK_INTERVAL_MINUTES=30
# PROACTIVE_STARTUP_DELAY_SECONDS=120

# -- Memory & conversation --
# MAX_CONVERSATION_HISTORY=50
# MAX_DECISIONS=500
# ENABLE_SEMANTIC_MEMORY=true

# -- Semantic memory tuning --
# SEMANTIC_MEMORY_MAX_ENTRIES=5000
# SEMANTIC_MEMORY_TEXT_MAX_LEN=2000
# SEMANTIC_MEMORY_SEARCH_TOP_K=5
# SEMANTIC_MEMORY_RECENCY_WEIGHT=0.15
# SEMANTIC_MEMORY_RECENCY_HALF_LIFE_DAYS=30
# MEMORY_SIMILARITY_THRESHOLD=0.5
# MEMORY_CONTEXT_RESULTS=3

# -- Memory consolidation (nightly merge of old memories) --
# MEMORY_CONSOLIDATION_HOUR=3
# MEMORY_CONSOLIDATION_MIN_AGE_DAYS=1.0
# MEMORY_CONSOLIDATION_BATCH_LIMIT=50
# MEMORY_CONSOLIDATION_BATCH_SIZE=10
# MEMORY_CONSOLIDATION_MIN_BATCH_SIZE=5
# CONSOLIDATION_STARTUP_DELAY_SECONDS=300
# CONSOLIDATION_CHECK_INTERVAL_SECONDS=600

# -- Knowledge store & memory document --
# ENABLE_KNOWLEDGE_STORE=true
# MEMORY_DOCUMENT_MAX_SIZE=4000
# KNOWLEDGE_AUTO_EXTRACT=true

# -- Energy entity overrides (defaults match Sungrow + Shelly + Amtron setup) --
# GRID_POWER_ENTITY=sensor.power_meter_active_power
# HOUSE_POWER_ENTITY=sensor.shelly3em_main_channel_total_power
# PV_POWER_ENTITY=sensor.inverter_input_power
# PV_AC_OUTPUT_ENTITY=sensor.inverter_active_power
# BATTERY_POWER_ENTITY=sensor.batteries_charge_discharge_power
# BATTERY_SOC_ENTITY=sensor.batteries_state_of_capacity
# EV_POWER_ENTITY=sensor.amtron_meter_total_power_w
# EV_ENERGY_ENTITY=sensor.amtron_meter_total_energy_kwh

# -- PV forecast entity overrides --
# PV_FORECAST_TODAY_ENTITY=sensor.pv_ai_forecast_today_kwh
# PV_FORECAST_TODAY_REMAINING_ENTITY=sensor.pv_ai_forecast_today_remaining_kwh
# PV_FORECAST_TOMORROW_ENTITY=sensor.pv_ai_forecast_tomorrow_kwh
# PV_EAST_ENERGY_ENTITY=sensor.inverter_pv_east_energy
# PV_WEST_ENERGY_ENTITY=sensor.inverter_pv_west_energy

# -- EV / weather / price entity overrides --
# EV_CHARGE_MODE_ENTITY=input_select.ev_charge_mode
# EV_TARGET_ENERGY_ENTITY=input_number.ev_target_energy_kwh
# EV_DEPARTURE_TIME_ENTITY=input_datetime.ev_departure_time
# WEATHER_ENTITY=weather.forecast_home
# EPEX_PRICE_ENTITY=sensor.epex_spot_data_price_2

# -- Google Calendar (optional — enables absence awareness & reminders) --
# 1. Create a Service Account in Google Cloud Console (enable Calendar API)
# 2. Download the JSON key file
# 3. Share your family calendar with the service account email (Viewer)
# 4. Create an "Orchestrator" calendar and share with the service account (Editor)
GOOGLE_CALENDAR_CREDENTIALS_FILE=/app/data/google-credentials.json
# Or use base64-encoded JSON for Docker convenience:
# GOOGLE_CALENDAR_CREDENTIALS_JSON=
GOOGLE_CALENDAR_FAMILY_ID=
GOOGLE_CALENDAR_ORCHESTRATOR_ID=

# -- Household --
HOUSEHOLD_USERS=Henning,Nicole
# HOUSEHOLD_LANGUAGE=de


# ╔═══════════════════════════════════════════════════════════╗
# ║  5. SERVICE: PV FORECAST                                  ║
# ╚═══════════════════════════════════════════════════════════╝

# -- PV array configuration --
# Entity IDs must be total_increasing cumulative kWh sensors
# (e.g. Riemann sum integration of the array power sensor)
PV_EAST_ENERGY_ENTITY_ID=sensor.inverter_pv_east_energy
PV_EAST_CAPACITY_KWP=5.0
PV_EAST_AZIMUTH=90
PV_EAST_TILT=30

PV_WEST_ENERGY_ENTITY_ID=sensor.inverter_pv_west_energy
PV_WEST_CAPACITY_KWP=5.0
PV_WEST_AZIMUTH=-90
PV_WEST_TILT=30

# -- Forecast.Solar comparison (optional — used as extra ML feature) --
FORECAST_SOLAR_EAST_ENTITY_ID=sensor.energy_production_today_east
FORECAST_SOLAR_WEST_ENTITY_ID=sensor.energy_production_today_west

# -- Location (leave at 0 to auto-detect from Home Assistant) --
PV_LATITUDE=0
PV_LONGITUDE=0

# -- ML model hyperparameters (Gradient Boosting) --
# MODEL_N_ESTIMATORS=200
# MODEL_MAX_DEPTH=5
# MODEL_LEARNING_RATE=0.05
# MODEL_SUBSAMPLE=0.8
# MODEL_MIN_SAMPLES_LEAF=10
# MODEL_MIN_TRAINING_SAMPLES=50
# MODEL_CV_FOLDS=3

# -- Scheduling --
# MODEL_RETRAIN_HOUR=1
# FORECAST_UPDATE_MINUTES=60
# MODEL_MIN_DAYS=14

# -- Fallback estimate (used when < MODEL_MIN_DAYS of training data) --
# FALLBACK_SYSTEM_EFFICIENCY=0.78
# FALLBACK_PEAK_IRRADIANCE=1000.0

# -- Data --
# DATA_HISTORY_DAYS=3650
# HA_SENSOR_PREFIX=sensor.pv_ai_forecast


# ╔═══════════════════════════════════════════════════════════╗
# ║  6. SERVICE: SMART EV CHARGING                            ║
# ╚═══════════════════════════════════════════════════════════╝

# -- Wallbox entity IDs (Amtron via Modbus) --
# WALLBOX_VEHICLE_STATE_ENTITY=sensor.amtron_vehicle_state_raw
# WALLBOX_POWER_ENTITY=sensor.amtron_meter_total_power_w
# WALLBOX_ENERGY_SESSION_ENTITY=sensor.amtron_charged_energy_session_kwh
# WALLBOX_HEMS_POWER_NUMBER=number.amtron_hems_power_limit_w

# -- EV battery SoC --
# Leave empty to disable SoC-based charging (falls back to manual kWh target).
# EV_SOC_ENTITY=sensor.audi_a6_avant_e_tron_state_of_charge
# EV_BATTERY_CAPACITY_ENTITY=input_number.ev_battery_capacity_kwh

# -- Energy sensors --
# Grid connection meter (positive = exporting, negative = importing)
# GRID_POWER_ENTITY=sensor.power_meter_active_power
# Household consumption (Shelly 3EM, always positive)
# HOUSE_POWER_ENTITY=sensor.shelly3em_main_channel_total_power
# PV DC input power
# PV_POWER_ENTITY=sensor.inverter_input_power

# -- Home battery --
# BATTERY_POWER_ENTITY=sensor.batteries_charge_discharge_power
# BATTERY_SOC_ENTITY=sensor.batteries_state_of_capacity
# BATTERY_MIN_SOC_PCT=20.0
# BATTERY_EV_ASSIST_MAX_W=2000.0

# -- PV forecast integration --
# PV_FORECAST_REMAINING_ENTITY=sensor.pv_ai_forecast_today_remaining_kwh
# PV_FORECAST_GOOD_KWH=15.0

# -- Wallbox power limits (W) --
# WALLBOX_MAX_POWER_W=11000
# WALLBOX_MIN_POWER_W=4200
# ECO_CHARGE_POWER_W=5000

# -- HA helper entity IDs (also used by ev-forecast) --
# CHARGE_MODE_ENTITY=input_select.ev_charge_mode
# FULL_BY_MORNING_ENTITY=input_boolean.ev_full_by_morning
# DEPARTURE_TIME_ENTITY=input_datetime.ev_departure_time
# TARGET_SOC_ENTITY=input_number.ev_target_soc_pct
# TARGET_ENERGY_ENTITY=input_number.ev_target_energy_kwh

# -- PV surplus tuning --
# GRID_RESERVE_W=200
# SURPLUS_START_HYSTERESIS_W=300
# RAMP_STEP_W=500

# -- Control loop --
# CONTROL_INTERVAL_SECONDS=30


# ╔═══════════════════════════════════════════════════════════╗
# ║  7. SERVICE: EV FORECAST                                  ║
# ╚═══════════════════════════════════════════════════════════╝

# -- EV battery specs (Audi A6 e-tron) --
EV_BATTERY_CAPACITY_GROSS_KWH=83.0
EV_BATTERY_CAPACITY_NET_KWH=76.0

# Default consumption — used as fallback until enough real data is collected.
# The service calculates actual consumption dynamically from mileage + SoC changes.
EV_CONSUMPTION_KWH_PER_100KM=22.0

# -- Audi Connect account mode --
#   true  = single account (Henning only, direct sensors — recommended)
#   false = dual account (Henning + Nicole, combined _comb sensors in HA)
AUDI_SINGLE_ACCOUNT=true

# -- EV sensor entities --
# Single-account mode: direct Audi Connect entities (no _comb suffix)
# Dual-account mode:   combined HA template sensors (with _comb suffix)
# EV_SOC_ENTITY=sensor.audi_a6_avant_e_tron_state_of_charge
# EV_RANGE_ENTITY=sensor.audi_a6_avant_e_tron_range
# EV_CHARGING_ENTITY=sensor.audi_a6_avant_e_tron_charging_state
# EV_PLUG_ENTITY=sensor.audi_a6_avant_e_tron_plug_state
# EV_MILEAGE_ENTITY=sensor.audi_a6_avant_e_tron_mileage
# EV_REMAINING_CHARGE_ENTITY=sensor.audi_a6_avant_e_tron_remaining_charge_time
# EV_CLIMATISATION_ENTITY=sensor.audi_a6_avant_e_tron_climatisation_state
# EV_ACTIVE_ACCOUNT_ENTITY=  (only needed in dual-account mode)

# -- Audi Connect account(s) --
# VIN needed for cloud data refresh via HA script
AUDI_ACCOUNT1_NAME=Henning
AUDI_ACCOUNT1_VIN=
# Second account (only when AUDI_SINGLE_ACCOUNT=false)
# AUDI_ACCOUNT2_NAME=Nicole
# AUDI_ACCOUNT2_VIN=

# -- Audi Connect refresh --
# AUDI_REFRESH_INTERVAL_MINUTES=30
# AUDI_STALE_THRESHOLD_MINUTES=60

# -- Trip prediction --
# Calendar event prefixes: "H: Stuttgart" = Henning drives, "N: Münster" = Nicole drives
# CALENDAR_PREFIX_HENNING=H:
# CALENDAR_PREFIX_NICOLE=N:

# Nicole's default commute (Mon-Thu to Lengerich, 22 km one way)
NICOLE_COMMUTE_KM=22.0
NICOLE_COMMUTE_DAYS=mon,tue,wed,thu
NICOLE_DEPARTURE_TIME=07:00
NICOLE_ARRIVAL_TIME=18:00

# Henning: trips over this distance → takes train (no EV impact)
HENNING_TRAIN_THRESHOLD_KM=350.0

# Known destinations with one-way distances in km (JSON)
# KNOWN_DESTINATIONS={"Münster": 60, "Aachen": 80, "STR": 500, "Lengerich": 22}

# -- Geocoding for unknown destinations --
# Auto-detects home coordinates from HA if set to 0
# HOME_LATITUDE=0
# HOME_LONGITUDE=0
# GEOCODING_ROAD_FACTOR=1.3

# -- Charging plan --
# PLANNING_HORIZON_DAYS=3
# MIN_SOC_PCT=20.0
# BUFFER_SOC_PCT=10.0
# MIN_ARRIVAL_SOC_PCT=15.0
# DEFAULT_ASSUMED_SOC_PCT=50.0

# -- Urgency thresholds --
# CRITICAL_URGENCY_HOURS=2.0     # Departure within 2h → Fast/Eco mode
# HIGH_URGENCY_HOURS=6.0         # Departure within 6h → Smart mode
# FAST_MODE_THRESHOLD_KWH=15.0   # Critical urgency + deficit >15 kWh → Fast (11kW)
# EARLY_DEPARTURE_HOUR=10        # Tomorrow before 10 AM → charge overnight

# -- HA helper entity IDs (shared with smart-ev-charging) --
# CHARGE_MODE_ENTITY=input_select.ev_charge_mode
# FULL_BY_MORNING_ENTITY=input_boolean.ev_full_by_morning
# DEPARTURE_TIME_ENTITY=input_datetime.ev_departure_time
# TARGET_ENERGY_ENTITY=input_number.ev_target_energy_kwh

# -- MQTT topics (internal, rarely need overriding) --
# ORCHESTRATOR_RESPONSE_TOPIC=homelab/ev-forecast/trip-response
# KNOWLEDGE_UPDATE_TOPIC=homelab/orchestrator/knowledge-update

# -- Scheduling --
# PLAN_UPDATE_MINUTES=30
# VEHICLE_CHECK_MINUTES=15


# ╔═══════════════════════════════════════════════════════════╗
# ║  8. SERVICE: HEALTH MONITOR                               ║
# ╚═══════════════════════════════════════════════════════════╝

# Telegram alerting (can reuse same bot token as orchestrator)
# TELEGRAM_ALERT_CHAT_IDS=

# Services to monitor (comma-separated)
# MONITORED_SERVICES=orchestrator,pv-forecast,smart-ev-charging,ev-forecast

# -- Monitoring intervals --
# HEARTBEAT_TIMEOUT_SECONDS=300
# INFRASTRUCTURE_CHECK_MINUTES=5
# DIAGNOSTIC_RUN_MINUTES=30
# DOCKER_CHECK_MINUTES=2
# ALERT_COOLDOWN_MINUTES=30
# DAILY_SUMMARY_HOUR=8
# HTTP_CHECK_TIMEOUT_SECONDS=10.0

# -- HA entity staleness --
# WATCHED_ENTITIES=sensor.inverter_input_power,sensor.power_meter_active_power,sensor.batteries_state_of_capacity
# ENTITY_CHECK_MINUTES=10

# -- Docker monitoring --
# DOCKER_SOCKET=/var/run/docker.sock
# COMPOSE_PROJECT=claude


# ╔═══════════════════════════════════════════════════════════╗
# ║  9. SERVICE: DASHBOARD                                    ║
# ╚═══════════════════════════════════════════════════════════╝

# DASHBOARD_PORT=8085
# DASHBOARD_TITLE=Homelab Dashboard
# DASHBOARD_USER_NAME=Dashboard

# -- Energy entity overrides (defaults match Sungrow + Shelly setup) --
# PV_POWER_ENTITY=sensor.inverter_input_power
# GRID_POWER_ENTITY=sensor.power_meter_active_power
# BATTERY_POWER_ENTITY=sensor.batteries_charge_discharge_power
# BATTERY_SOC_ENTITY=sensor.batteries_state_of_capacity
# HOUSE_POWER_ENTITY=sensor.shelly3em_main_channel_total_power
# INVERTER_POWER_ENTITY=sensor.inverter_active_power

# -- EV entity overrides --
# EV_CHARGE_POWER_ENTITY=sensor.amtron_meter_total_power_w
# EV_SESSION_ENERGY_ENTITY=sensor.amtron_meter_total_energy_kwh
# EV_SOC_ENTITY=sensor.audi_a6_avant_e_tron_state_of_charge
# EV_RANGE_ENTITY=sensor.audi_a6_avant_e_tron_range
# EV_PLUG_ENTITY=binary_sensor.audi_a6_avant_e_tron_plugged_in

# -- EV control entity overrides --
# EV_CHARGE_MODE_ENTITY=input_select.ev_charge_mode
# EV_TARGET_SOC_ENTITY=input_number.ev_target_soc_pct
# EV_DEPARTURE_TIME_ENTITY=input_datetime.ev_departure_time
# EV_FULL_BY_MORNING_ENTITY=input_boolean.ev_full_by_morning

# -- PV forecast entity overrides --
# PV_FORECAST_TODAY_ENTITY=sensor.pv_ai_forecast_today_kwh
# PV_FORECAST_TOMORROW_ENTITY=sensor.pv_ai_forecast_tomorrow_kwh
# PV_FORECAST_REMAINING_ENTITY=sensor.pv_ai_forecast_today_remaining_kwh

# -- Safe mode & refresh --
# SAFE_MODE_ENTITY_ID=input_boolean.homelab_safe_mode
# HA_POLL_INTERVAL=10
# UI_REFRESH_INTERVAL=3


# ╔═══════════════════════════════════════════════════════════╗
# ║  10. TRAEFIK (REVERSE PROXY)                              ║
# ╚═══════════════════════════════════════════════════════════╝
# Traefik is expected to be running on the Docker host already.
# These settings configure which services are exposed externally.

TRAEFIK_DASHBOARD_HOST=cockpit.local.schuettken.net
# TRAEFIK_ENTRYPOINT=websecure
# TRAEFIK_NETWORK=traefik


# ╔═══════════════════════════════════════════════════════════╗
# ║  11. GLOBAL SETTINGS                                      ║
# ╚═══════════════════════════════════════════════════════════╝

LOG_LEVEL=INFO
TIMEZONE=Europe/Berlin
# HEARTBEAT_INTERVAL_SECONDS=60

# Global safe mode — blocks all write actions across all services when enabled
# SAFE_MODE_ENTITY=input_boolean.homelab_safe_mode

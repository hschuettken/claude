services:
  # =============================================================
  # Infrastructure services
  # =============================================================

  mqtt:
    image: eclipse-mosquitto:2
    restart: unless-stopped
    ports:
      - "1883:1883"
    volumes:
      - ./infrastructure/mosquitto/config:/mosquitto/config
      - mosquitto_data:/mosquitto/data
    networks:
      - homelab

  # Uncomment if you want to run InfluxDB locally (skip if external)
  # influxdb:
  #   image: influxdb:2
  #   restart: unless-stopped
  #   ports:
  #     - "8086:8086"
  #   volumes:
  #     - influxdb_data:/var/lib/influxdb2
  #   environment:
  #     DOCKER_INFLUXDB_INIT_MODE: setup
  #     DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUXDB_INIT_USER:-admin}
  #     DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUXDB_INIT_PASSWORD:-changeme}
  #     DOCKER_INFLUXDB_INIT_ORG: ${INFLUXDB_ORG:-homelab}
  #     DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUXDB_BUCKET:-homeassistant}
  #   networks:
  #     - homelab

  # Uncomment to enable local AI with Ollama
  # ollama:
  #   image: ollama/ollama:latest
  #   restart: unless-stopped
  #   ports:
  #     - "11434:11434"
  #   volumes:
  #     - ollama_data:/root/.ollama
  #   # Uncomment for GPU passthrough (NVIDIA):
  #   # deploy:
  #   #   resources:
  #   #     reservations:
  #   #       devices:
  #   #         - driver: nvidia
  #   #           count: all
  #   #           capabilities: [gpu]
  #   networks:
  #     - homelab

  # =============================================================
  # Application services â€” add your services below
  # =============================================================

  pv-forecast:
    build:
      context: .
      dockerfile: services/pv-forecast/Dockerfile
    restart: unless-stopped
    env_file: .env
    volumes:
      - ./shared:/app/shared:ro
      - pv_forecast_data:/app/data
    depends_on:
      - mqtt
    networks:
      - homelab

  smart-ev-charging:
    build:
      context: .
      dockerfile: services/smart-ev-charging/Dockerfile
    restart: unless-stopped
    env_file: .env
    volumes:
      - ./shared:/app/shared:ro
      - smart_ev_charging_data:/app/data
    depends_on:
      - mqtt
    networks:
      - homelab

  orchestrator:
    build:
      context: .
      dockerfile: services/orchestrator/Dockerfile
    restart: unless-stopped
    env_file: .env
    ports:
      - "8050:8050"
    volumes:
      - ./shared:/app/shared:ro
      - orchestrator_data:/app/data
    depends_on:
      - mqtt
    networks:
      - homelab

  ev-forecast:
    build:
      context: .
      dockerfile: services/ev-forecast/Dockerfile
    restart: unless-stopped
    env_file: .env
    volumes:
      - ./shared:/app/shared:ro
      - ev_forecast_data:/app/data
    depends_on:
      - mqtt
    networks:
      - homelab

  example-service:
    build:
      context: .
      dockerfile: services/example-service/Dockerfile
    restart: unless-stopped
    env_file: .env
    volumes:
      - ./shared:/app/shared:ro
    depends_on:
      - mqtt
    networks:
      - homelab

  health-monitor:
    build:
      context: .
      dockerfile: services/health-monitor/Dockerfile
    restart: unless-stopped
    env_file: .env
    volumes:
      - ./shared:/app/shared:ro
      - health_monitor_data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - mqtt
    networks:
      - homelab

  dashboard:
    build:
      context: .
      dockerfile: services/dashboard/Dockerfile
    restart: unless-stopped
    env_file: .env
    ports:
      - "8085:8085"
    volumes:
      - ./shared:/app/shared:ro
      - dashboard_data:/app/data
    depends_on:
      - mqtt
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.homelab-dashboard.rule=Host(`${TRAEFIK_DASHBOARD_HOST:-cockpit.local.schuettken.net}`)"
      - "traefik.http.routers.homelab-dashboard.entrypoints=${TRAEFIK_ENTRYPOINT:-websecure}"
      - "traefik.http.routers.homelab-dashboard.tls=true"
      - "traefik.http.services.homelab-dashboard.loadbalancer.server.port=8085"
    networks:
      - homelab
      - traefik

  # --- Template for new services ---
  # my-new-service:
  #   build:
  #     context: .
  #     dockerfile: services/my-new-service/Dockerfile
  #   restart: unless-stopped
  #   env_file: .env
  #   volumes:
  #     - ./shared:/app/shared:ro
  #   depends_on:
  #     - mqtt
  #   networks:
  #     - homelab

# =============================================================
# Volumes & Networks
# =============================================================

volumes:
  pv_forecast_data:
  smart_ev_charging_data:
  ev_forecast_data:
  orchestrator_data:
  health_monitor_data:
  dashboard_data:
  mosquitto_data:
  # influxdb_data:
  # ollama_data:

networks:
  homelab:
    driver: bridge
  traefik:
    external: true
    name: ${TRAEFIK_NETWORK:-traefik}
